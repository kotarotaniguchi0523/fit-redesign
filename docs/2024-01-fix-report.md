# 問題データ修正・バグ修正レポート

## 概要

本ドキュメントは、fit-redesignプロジェクトで発見された複数の問題に対する修正内容を詳細に記録したものである。

---

## 修正した問題一覧

1. 2013年度の単元選択バグ
2. AIが適当に作成した問題文（PDFと乖離）
3. 表組みが見づらい（区切り線なし）
4. 年度データの欠落

---

## 問題1: 2013年度の単元選択バグ

### 症状

2013年度を選択し、任意の単元（例：オートマトン）を選んだ後、年度を2017年に切り替えると、選択していた単元に関係なく「基数変換」に戻ってしまう。

### 原因

タブコンポーネントが「非制御コンポーネント」として実装されていた。

```
┌────────────────────────────────────────────────────────┐
│ 非制御コンポーネント（修正前）                          │
├────────────────────────────────────────────────────────┤
│                                                        │
│   Tabs コンポーネント                                   │
│   ┌──────────────────────────────────────────┐        │
│   │ 内部状態: selectedIndex = 6              │        │
│   │ （オートマトンを選択中）                  │        │
│   └──────────────────────────────────────────┘        │
│                                                        │
│   ↓ 年度を2017年に変更                                 │
│                                                        │
│   タブ配列が変わる:                                     │
│   2013年: [基数, 負数, 浮動, 論理, 集合, 確率,          │
│           オートマトン, 符号, データ] ← 9個            │
│   2017年: [基数+負数, 浮動+論理, 集合+確率,             │
│           オート+符号, データ+ソート] ← 5個            │
│                                                        │
│   内部状態 selectedIndex = 6 は 2017年配列に存在しない │
│   → HeroUIが自動的にindex=0にリセット                  │
│   → 「基数変換」が表示される                           │
│                                                        │
└────────────────────────────────────────────────────────┘
```

### 修正内容

タブコンポーネントを「制御コンポーネント」に変換した。

```
┌────────────────────────────────────────────────────────┐
│ 制御コンポーネント（修正後）                            │
├────────────────────────────────────────────────────────┤
│                                                        │
│   UnitTabs コンポーネント                               │
│   ┌──────────────────────────────────────────┐        │
│   │ 状態: selectedKey (親が管理)              │        │
│   └──────────────────────────────────────────┘        │
│           │                                            │
│           ↓                                            │
│   ┌──────────────────────────────────────────┐        │
│   │ useEffect:                                │        │
│   │ selectedYear が変わったら                │        │
│   │ selectedKey を tabs[0].id にリセット     │        │
│   └──────────────────────────────────────────┘        │
│           │                                            │
│           ↓                                            │
│   ┌──────────────────────────────────────────┐        │
│   │ Tabs コンポーネント                       │        │
│   │ selectedKey={selectedKey}                │        │
│   │ onSelectionChange={handleSelectionChange}│        │
│   └──────────────────────────────────────────┘        │
│                                                        │
│   年度変更時に必ず最初のタブにリセットされる           │
│                                                        │
└────────────────────────────────────────────────────────┘
```

### 修正ファイル

- `src/components/UnitTabs.tsx`

### 修正の詳細

1. `useState` で `selectedKey` 状態を追加
2. `useEffect` で `selectedYear` 変更時に `selectedKey` をリセット
3. `<Tabs>` に `selectedKey` と `onSelectionChange` props を追加

---

## 問題2: AIが適当に作成した問題文

### 症状

一部の問題ファイルで、問題文が「〜に関する問題」のような抽象的な記述になっており、実際のPDF問題文が反映されていなかった。

### 該当ファイルと状態

```
┌──────────────────────────────────────────────────────────┐
│ exam8-stack-2017.ts（最も深刻）                          │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ 修正前:                                                  │
│ ┌────────────────────────────────────────────┐          │
│ │ 問題1: 「二分木の表現に関する問題」         │          │
│ │ 問題2: 「ポインタ操作の問題」               │          │
│ │ 問題3: 「変数の値を求める問題」             │          │
│ │ 問題4: 「文字列処理の問題」                 │          │
│ │ 問題5: 「データ構造の種類を答える問題」     │          │
│ └────────────────────────────────────────────┘          │
│                                                          │
│ 修正後:                                                  │
│ ┌────────────────────────────────────────────┐          │
│ │ 問題1: 「次の順にデータを挿入した二分探索木を、│         │
│ │        S式（括弧表記）で表せ。               │          │
│ │        27, 7, 51, 20, 6, 19」               │          │
│ │ 問題2: 「次のリスト(N, E, W, S)から、要素 E │          │
│ │        を削除するために書き換えるアドレス、 │          │
│ │        データ、ポインタを示せ。」           │          │
│ │ ...（以下具体的な問題文）                   │          │
│ └────────────────────────────────────────────┘          │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

```
┌──────────────────────────────────────────────────────────┐
│ exam5-ecc-2015.ts（選択肢が空）                          │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ 修正前:                                                  │
│ ┌────────────────────────────────────────────┐          │
│ │ options: [                                  │          │
│ │   { label: "ア", value: "" },              │ ← 空文字  │
│ │   { label: "イ", value: "" },              │          │
│ │   { label: "ウ", value: "" },              │          │
│ │   { label: "エ", value: "" },              │          │
│ │ ]                                           │          │
│ └────────────────────────────────────────────┘          │
│                                                          │
│ 修正後:                                                  │
│ ┌────────────────────────────────────────────┐          │
│ │ options: [                                  │          │
│ │   { label: "ア", value: "x1 = x2 ⊕ c" },  │          │
│ │   { label: "イ", value: "0 ⊕ x1 = ..." }, │          │
│ │   { label: "ウ", value: "x1 ⊕ x2 ⊕ 1..." },│          │
│ │   { label: "エ", value: "x1 ⊕ x2 ⊕ c..." },│          │
│ │ ]                                           │          │
│ └────────────────────────────────────────────┘          │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### 修正ファイル

- `src/data/exams/exam8-stack-2017.ts` - 5問すべて具体化
- `src/data/exams/exam1-base-2017.ts` - 問題文と選択肢を精査
- `src/data/exams/exam5-ecc-2015.ts` - 空の選択肢を修正

### 修正方法

1. PDFファイル（`public/pdf/Exam*.pdf`）を参照
2. 解答HTML（`public/pdf/Exam*-Ans.html`）から解答を確認
3. 他年度の類似問題を参考に問題文を作成
4. 解答と問題文の整合性を検証

---

## 問題3: 表組みが見づらい

### 症状

問題文中の表データが改行区切りのテキストで記述されており、視覚的に見づらかった。

### 修正前の状態

```
┌──────────────────────────────────────────────────────────┐
│ exam8-stack-2016.ts 問題2                                │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ 問題文内のテキスト:                                       │
│ ┌────────────────────────────────────────────┐          │
│ │ "アドレス データ ポインタ\n                 │          │
│ │  100     E     200\n                       │          │
│ │  200     W     300\n                       │          │
│ │  300     S     0\n                         │          │
│ │  400     N     100"                        │          │
│ └────────────────────────────────────────────┘          │
│                                                          │
│ 画面表示:                                                │
│ ┌────────────────────────────────────────────┐          │
│ │ アドレス データ ポインタ                    │ ← 区切りなし │
│ │ 100     E     200                          │ 見づらい   │
│ │ 200     W     300                          │          │
│ │ 300     S     0                            │          │
│ │ 400     N     100                          │          │
│ └────────────────────────────────────────────┘          │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### 修正内容

#### ステップ1: 型定義の追加

`src/types/figures.ts` に4種類のテーブル型を追加した。

```
┌──────────────────────────────────────────────────────────┐
│ 追加した型定義                                            │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ 1. DataTableColumn / DataTableRow                        │
│    └── 汎用テーブル用                                    │
│                                                          │
│ 2. HuffmanTableData                                      │
│    └── ハフマン符号表用                                  │
│    └── characters: ["A", "B", "C", ...]                  │
│    └── probabilities: [0.66, 0.12, ...]                  │
│                                                          │
│ 3. LinkedListEntry                                       │
│    └── リンクリスト/ポインタ表用                         │
│    └── address, data, pointer                            │
│                                                          │
│ 4. NormalDistributionEntry                               │
│    └── 正規分布表用                                      │
│    └── u, probability                                    │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

#### ステップ2: FigureData型の拡張

`src/types/index.ts` のFigureData union型に新しい型を追加した。

```
FigureData =
  | { type: "stateDiagram"; ... }      ← 既存
  | { type: "binaryTree"; ... }        ← 既存
  | { type: "truthTable"; ... }        ← 既存
  | { type: "parityCheck"; ... }       ← 既存
  | { type: "dataTable"; ... }         ← 新規追加
  | { type: "huffmanTable"; ... }      ← 新規追加
  | { type: "linkedListTable"; ... }   ← 新規追加
  | { type: "normalDistributionTable"; ... } ← 新規追加
```

#### ステップ3: TableRendererコンポーネントの作成

`src/components/figures/TableRenderer.tsx` を新規作成した。

```
┌──────────────────────────────────────────────────────────┐
│ TableRenderer コンポーネント構造                         │
├──────────────────────────────────────────────────────────┤
│                                                          │
│   TableRenderer                                          │
│   │                                                      │
│   ├── figureData.type === "dataTable"                   │
│   │   └── DataTable コンポーネント                       │
│   │                                                      │
│   ├── figureData.type === "huffmanTable"                │
│   │   └── HuffmanTable コンポーネント                    │
│   │       ┌───────────────────────────────┐             │
│   │       │ 文字 │ A   │ B   │ C   │ ... │             │
│   │       ├───────────────────────────────┤             │
│   │       │ 確率 │0.66 │0.12 │0.09 │ ... │             │
│   │       └───────────────────────────────┘             │
│   │                                                      │
│   ├── figureData.type === "linkedListTable"             │
│   │   └── LinkedListTable コンポーネント                 │
│   │       ┌───────────────────────────────┐             │
│   │       │アドレス│データ│ポインタ│             │
│   │       ├───────────────────────────────┤             │
│   │       │  100   │  E  │  200   │             │
│   │       │  200   │  W  │  300   │             │
│   │       └───────────────────────────────┘             │
│   │                                                      │
│   └── figureData.type === "normalDistributionTable"     │
│       └── NormalDistributionTable コンポーネント         │
│           ┌───────────────────────────────┐             │
│           │  u   │ 0.0  │ 1.0  │ 2.0  │...│             │
│           ├───────────────────────────────┤             │
│           │Pr(U>u)│ 0.5  │0.159 │0.023 │...│             │
│           └───────────────────────────────┘             │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

#### ステップ4: 問題データの変換

各問題ファイルのテキスト形式の表をfigureData形式に変換した。

```
┌──────────────────────────────────────────────────────────┐
│ exam8-stack-2016.ts 問題2（修正後）                      │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ 修正前: text に全部入っていた                            │
│ 修正後:                                                  │
│                                                          │
│ {                                                        │
│   text: "次のリスト(N, E, W, S)から、要素 E を削除...",  │
│   figureData: {                                          │
│     type: "linkedListTable",                             │
│     entries: [                                           │
│       { address: 100, data: "E", pointer: 200 },        │
│       { address: 200, data: "W", pointer: 300 },        │
│       { address: 300, data: "S", pointer: 0 },          │
│       { address: 400, data: "N", pointer: 100 },        │
│     ]                                                    │
│   }                                                      │
│ }                                                        │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### 修正ファイル

- `src/types/figures.ts` - 型定義追加
- `src/types/index.ts` - FigureData型拡張
- `src/components/figures/TableRenderer.tsx` - 新規作成
- `src/components/figures/index.ts` - エクスポート追加
- `src/components/QuestionCard.tsx` - TableRenderer統合
- `src/data/exams/exam8-stack-2016.ts` - linkedListTable形式に変換
- `src/data/exams/exam7-ecc-2014.ts` - huffmanTable形式に変換
- `src/data/exams/exam6-fsm-2014.ts` - normalDistributionTable形式に変換

---

## 問題4: 年度データの欠落

### 症状

複数の単元で特定の年度の問題データが欠落しており、UIで「準備中」と表示されていた。

### 欠落状況（修正前）

```
┌──────────────────────────────────────────────────────────┐
│ 年度データ欠落マトリクス（修正前）                        │
├──────────────────────────────────────────────────────────┤
│                                                          │
│         2013  2014  2015  2016  2017                     │
│ exam2    ✓     ✗     ✓     ✓     ✓                      │
│ exam6    ✓     ✓     ✗     ✓     ✓                      │
│ exam7    ✓     ✓     ✗     ✓     ✓                      │
│ exam8    ✓     ✗     ✗     ✓     ✓                      │
│                                                          │
│ ✗ = 欠落                                                 │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### 修正内容

4つの新規ファイルを作成し、index.tsに登録した。

```
┌──────────────────────────────────────────────────────────┐
│ 新規作成ファイル                                         │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ 1. exam2-negative-2014.ts                                │
│    └── 負数表現（2014年度）                              │
│    └── 参照: Exam2b-Negative.pdf, Exam2014-Ans.html     │
│    └── 5問作成                                           │
│                                                          │
│ 2. exam6-fsm-2015.ts                                     │
│    └── FSM・確率（2015年度）                             │
│    └── 参照: Exam6c-FSM.pdf, Exam2015-Ans.html          │
│    └── 5問作成                                           │
│                                                          │
│ 3. exam7-ecc-2015.ts                                     │
│    └── 符号理論（2015年度）                              │
│    └── 参照: Exam7c-ECC.pdf, Exam2015-Ans.html          │
│    └── 5問作成                                           │
│                                                          │
│ 4. exam8-stack-2014.ts                                   │
│    └── データ構造（2014年度）                            │
│    └── 参照: Exam8b-Stack.pdf, Exam2014-Ans.html        │
│    └── 5問作成                                           │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### index.tsへの登録

```
┌──────────────────────────────────────────────────────────┐
│ exams/index.ts の変更                                    │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ 追加したインポート:                                       │
│ ┌────────────────────────────────────────────┐          │
│ │ import { exam2_2014 } from "./exam2-negative-2014"; │  │
│ │ import { exam6_2015 } from "./exam6-fsm-2015";      │  │
│ │ import { exam7_2015 } from "./exam7-ecc-2015";      │  │
│ │ import { exam8_2014 } from "./exam8-stack-2014";    │  │
│ └────────────────────────────────────────────┘          │
│                                                          │
│ 追加したExam定義:                                         │
│ ┌────────────────────────────────────────────┐          │
│ │ exam2Exams["2014"] = { ... questions: exam2_2014 }  │  │
│ │ exam6Exams["2015"] = { ... questions: exam6_2015 }  │  │
│ │ exam7Exams["2015"] = { ... questions: exam7_2015 }  │  │
│ │ exam8Exams["2014"] = { ... questions: exam8_2014 }  │  │
│ └────────────────────────────────────────────┘          │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### 欠落状況（修正後）

```
┌──────────────────────────────────────────────────────────┐
│ 年度データ欠落マトリクス（修正後）                        │
├──────────────────────────────────────────────────────────┤
│                                                          │
│         2013  2014  2015  2016  2017                     │
│ exam2    ✓     ✓     ✓     ✓     ✓    ← 2014追加        │
│ exam6    ✓     ✓     ✓     ✓     ✓    ← 2015追加        │
│ exam7    ✓     ✓     ✓     ✓     ✓    ← 2015追加        │
│ exam8    ✓     ✓     ✗     ✓     ✓    ← 2014追加        │
│                                                          │
│ ※exam8の2015年は引き続き欠落（PDFが存在しない）         │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

## 修正ファイル一覧

### 変更したファイル（11ファイル）

| ファイル | 修正内容 |
|----------|----------|
| `src/components/UnitTabs.tsx` | 制御コンポーネント化 |
| `src/components/QuestionCard.tsx` | TableRenderer統合 |
| `src/components/figures/index.ts` | TableRendererエクスポート追加 |
| `src/types/figures.ts` | 4種類のテーブル型追加 |
| `src/types/index.ts` | FigureData型拡張 |
| `src/data/exams/index.ts` | 4ファイルのインポート・登録 |
| `src/data/exams/exam8-stack-2017.ts` | 問題文具体化 |
| `src/data/exams/exam1-base-2017.ts` | 問題文精査 |
| `src/data/exams/exam5-ecc-2015.ts` | 選択肢修正 |
| `src/data/exams/exam8-stack-2016.ts` | linkedListTable形式に変換 |
| `src/data/exams/exam7-ecc-2014.ts` | huffmanTable形式に変換 |
| `src/data/exams/exam6-fsm-2014.ts` | normalDistributionTable形式に変換 |

### 新規作成したファイル（5ファイル）

| ファイル | 内容 |
|----------|------|
| `src/components/figures/TableRenderer.tsx` | 汎用テーブルレンダリング |
| `src/data/exams/exam2-negative-2014.ts` | 負数表現2014年度 |
| `src/data/exams/exam6-fsm-2015.ts` | FSM2015年度 |
| `src/data/exams/exam7-ecc-2015.ts` | 符号理論2015年度 |
| `src/data/exams/exam8-stack-2014.ts` | データ構造2014年度 |

---

## 実装フロー

```
Wave 1（並列4タスク）
├── UnitTabs.tsx 制御コンポーネント化
├── exam8-stack-2017.ts 問題文具体化
├── exam1-base-2017.ts 問題文精査
└── exam5-ecc-2015.ts 選択肢修正
     │
     ↓ レビュー
     │
Wave 2（単独）
└── 型定義追加（figures.ts, index.ts）
     │
     ↓
     │
Wave 3（並列4タスク）
├── exam8-stack-2016.ts 表データ化
├── exam7-ecc-2014.ts 表データ化
├── exam6-fsm-2014.ts 表データ化
└── TableRenderer.tsx 作成
     │
     ↓ レビュー
     │
Wave 4（並列4タスク）
├── exam2-negative-2014.ts 作成
├── exam6-fsm-2015.ts 作成
├── exam7-ecc-2015.ts 作成
└── exam8-stack-2014.ts 作成
     │
     ↓
     │
Wave 5（単独）
└── index.ts 更新
     │
     ↓ 最終レビュー
     │
完了
```

---

## 残存する既知の問題

### 1. 一部PDFファイルの不足

以下のPDFファイルは存在しないため、問題データは解答HTMLから逆算して作成している。

- `Exam1e-Base.pdf`（2017年基数変換）
- `Exam5c-ECC.pdf`（2015年符号理論）
- `Exam8e-Stack.pdf`（2017年データ構造）

### 2. ハッシュ衝突問題の解答

`exam8-stack-2016.ts` と `exam8-stack-2014.ts` のハッシュ衝突問題で、計算結果と解答HTMLの値に差異がある。解答HTMLの値を採用しているが、正確性は要確認。

### 3. 引き続き欠落している年度

- exam3: 2014, 2016, 2017年
- exam5: 2014, 2016, 2017年
- exam8: 2015年
- exam9: 2015, 2016, 2017年

これらはPDFファイルが存在しないか、カリキュラム変更により該当年度の問題が存在しない可能性がある。

---

## 検証方法

1. `pnpm build` でビルドエラーがないことを確認
2. `pnpm dev` で開発サーバーを起動
3. 2013年度を選択し、「オートマトン」タブを選択
4. 年度を2017年に変更し、最初のタブが選択されることを確認
5. 各単元の問題を表示し、表が適切にレンダリングされることを確認
6. 新規追加した年度（exam2-2014等）が正しく表示されることを確認

---

## 作成日

2024年1月24日
